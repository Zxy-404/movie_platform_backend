# 电影分类关联功能说明

## 功能概述

为分类服务添加了电影分类关联管理功能，实现电影与分类之间的多对多关系管理。基于数据库中的 `movie_category` 关联表，提供完整的增删改查操作。

## 数据库设计

### movie_category 表结构
```sql
CREATE TABLE `movie_category` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `movie_id` int UNSIGNED NOT NULL COMMENT '电影ID',
  `category_id` int UNSIGNED NOT NULL COMMENT '分类ID',
  `create_time` datetime NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE INDEX `idx_movie_category`(`movie_id` ASC, `category_id` ASC) USING BTREE
)
```

**设计特点：**
- ✅ **唯一性约束**：同一电影与分类只能关联一次
- ✅ **外键约束**：确保数据完整性
- ✅ **级联删除**：电影或分类删除时自动清理关联

## 新增文件结构

```
src/main/java/com/edu/bcu/
├── entity/
│   ├── MovieCategory.java              # 电影分类关联实体
│   └── Movie.java                      # 电影实体（简化版）
├── dto/
│   ├── MovieCategoryDTO.java           # 单个关联DTO
│   └── BatchMovieCategoryDTO.java      # 批量关联DTO
├── repository/
│   └── MovieCategoryRepository.java    # 关联数据访问层
├── service/
│   ├── MovieCategoryService.java       # 关联服务接口
│   └── impl/
│       └── MovieCategoryServiceImpl.java # 关联服务实现
└── controller/
    └── MovieCategoryController.java     # 关联控制器
```

## API 接口文档

### 基础路径
```
/api/movie-categories
```

### 1. 添加电影分类关联
**POST** `/api/movie-categories`

**请求体：**
```json
{
  "movieId": 1,
  "categoryId": 2
}
```

**响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "movieId": 1,
    "categoryId": 2,
    "createTime": "2024-01-01T10:00:00"
  }
}
```

### 2. 批量添加电影分类关联
**POST** `/api/movie-categories/batch`

**请求体：**
```json
{
  "movieId": 1,
  "categoryIds": [1, 2, 3, 4]
}
```

**响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "movieId": 1,
      "categoryId": 1,
      "createTime": "2024-01-01T10:00:00"
    },
    {
      "id": 2,
      "movieId": 1,
      "categoryId": 2,
      "createTime": "2024-01-01T10:00:00"
    }
  ]
}
```

### 3. 删除电影分类关联
**DELETE** `/api/movie-categories?movieId=1&categoryId=2`

### 4. 批量删除电影分类关联
**DELETE** `/api/movie-categories/batch?movieId=1`

**请求体：**
```json
[1, 2, 3]
```

### 5. 删除电影所有分类关联
**DELETE** `/api/movie-categories/movie/{movieId}`

### 6. 更新电影分类关联
**PUT** `/api/movie-categories/movie/{movieId}`

**请求体：**
```json
[1, 2, 3, 4]
```

**说明：** 先删除该电影的所有分类关联，再添加新的关联

### 7. 获取电影的所有分类
**GET** `/api/movie-categories/movie/{movieId}`

### 8. 获取分类下的所有电影
**GET** `/api/movie-categories/category/{categoryId}`

### 9. 检查关联是否存在
**GET** `/api/movie-categories/exists?movieId=1&categoryId=2`

### 10. 统计分类下的电影数量
**GET** `/api/movie-categories/count/category/{categoryId}`

### 11. 统计电影的分类数量
**GET** `/api/movie-categories/count/movie/{movieId}`

## 业务逻辑特性

### 🛡️ 数据验证
- **分类存在性验证**：添加关联前验证分类是否存在
- **重复关联检查**：防止同一电影与分类重复关联
- **参数校验**：完整的DTO参数验证

### 🔄 事务管理
- **原子操作**：批量操作要么全部成功，要么全部失败
- **一致性保证**：更新操作确保数据一致性

### 📊 统计功能
- **分类热度**：统计每个分类下的电影数量
- **电影标签**：统计每部电影的分类数量

### 🔍 查询优化
- **索引支持**：基于唯一索引的快速查询
- **懒加载**：关联查询采用懒加载策略

## 错误处理

### 新增错误码
```java
MOVIE_CATEGORY_EXIST(2100, "电影分类关联已存在"),
MOVIE_CATEGORY_NOT_EXIST(2101, "电影分类关联不存在")
```

### 异常场景
1. **分类不存在**：添加关联时分类ID不存在
2. **重复关联**：尝试添加已存在的关联
3. **关联不存在**：删除不存在的关联
4. **参数错误**：请求参数验证失败

## 使用示例

### 场景1：为电影添加分类标签
```bash
# 为电影ID=1添加"动作片"分类
curl -X POST http://localhost:8080/api/movie-categories \
  -H "Content-Type: application/json" \
  -d '{"movieId": 1, "categoryId": 1}'
```

### 场景2：批量设置电影分类
```bash
# 为电影ID=1设置多个分类
curl -X POST http://localhost:8080/api/movie-categories/batch \
  -H "Content-Type: application/json" \
  -d '{"movieId": 1, "categoryIds": [1, 2, 3]}'
```

### 场景3：更新电影分类
```bash
# 替换电影ID=1的所有分类
curl -X PUT http://localhost:8080/api/movie-categories/movie/1 \
  -H "Content-Type: application/json" \
  -d '[2, 4, 5]'
```

### 场景4：查询分类下的电影
```bash
# 查询"动作片"分类下的所有电影
curl -X GET http://localhost:8080/api/movie-categories/category/1
```

## 技术亮点

1. **🎯 精简设计**：只关注关联关系，不冗余电影信息
2. **🔧 灵活操作**：支持单个和批量操作
3. **📚 完整文档**：Swagger API文档完整
4. **🛡️ 安全可靠**：完整的参数验证和异常处理
5. **⚡ 高性能**：基于索引的快速查询
6. **🔄 事务保证**：关键操作的事务一致性

## 注意事项

1. **电影服务依赖**：需要电影服务提供电影信息验证
2. **分类删除影响**：删除分类时会级联删除相关关联
3. **批量操作限制**：建议单次批量操作不超过100个关联
4. **并发处理**：高并发场景下注意唯一约束冲突处理

该功能完整实现了电影与分类的多对多关联管理，为电影平台提供了灵活的分类标签系统。 